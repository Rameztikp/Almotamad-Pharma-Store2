# نظام الإشعارات المخزنة - Persistent Notifications System

## نظرة عامة

تم تطوير نظام إشعارات شامل يدعم كل من الإشعارات الفورية (SSE) والإشعارات المخزنة في قاعدة البيانات. يوفر النظام تجربة مستخدم محسنة مع إشعارات في الوقت الفعلي وإمكانية الوصول للإشعارات السابقة.

## المكونات الرئيسية

### Backend (Go)

#### 1. النماذج (Models)
- **`models/notification.go`**: نموذج الإشعار مع الحقول الأساسية
- **الحقول**: ID, UserID, Title, Message, Type, Metadata, ReadAt, CreatedAt, UpdatedAt

#### 2. الخدمات (Services)
- **`services/notification_service.go`**: خدمة إدارة الإشعارات
- **الوظائف**:
  - `CreateNotification()`: إنشاء إشعار جديد
  - `GetUserNotifications()`: جلب إشعارات المستخدم
  - `MarkAsRead()`: تحديد إشعار كمقروء
  - `MarkAllAsRead()`: تحديد جميع الإشعارات كمقروءة
  - `GetUnreadCount()`: عدد الإشعارات غير المقروءة

#### 3. المعالجات (Handlers)
- **`handlers/user_notifications.go`**: معالجات API للإشعارات
- **`handlers/notifications.go`**: معالج SSE للإشعارات الفورية

#### 4. قاعدة البيانات
- **`migrations/004_create_notifications_table.sql`**: إنشاء جدول الإشعارات
- **الفهارس**: محسنة للاستعلامات السريعة

### Frontend (React)

#### 1. المكونات (Components)
- **`NotificationCenter.jsx`**: مكون مركز الإشعارات الرئيسي
- **`NotificationCenter.css`**: تنسيقات المكون

#### 2. الخدمات (Services)
- **`notificationService.js`**: خدمة الإشعارات مع دعم API و SSE

## API Endpoints

### إشعارات المستخدم
```
GET    /api/v1/notifications              # جلب الإشعارات
GET    /api/v1/notifications/stream       # SSE للإشعارات الفورية
PUT    /api/v1/notifications/:id/read     # تحديد إشعار كمقروء
PUT    /api/v1/notifications/read-all     # تحديد الكل كمقروء
GET    /api/v1/notifications/unread-count # عدد غير المقروءة
```

### معاملات الاستعلام
- `limit`: عدد الإشعارات (افتراضي: 20، حد أقصى: 100)
- `unread`: إظهار غير المقروءة فقط (true/false)

## الميزات

### 1. الإشعارات الفورية
- **SSE (Server-Sent Events)**: إشعارات في الوقت الفعلي
- **إعادة الاتصال التلقائي**: في حالة انقطاع الاتصال
- **دعم المتصفح**: إشعارات المتصفح الأصلية

### 2. الإشعارات المخزنة
- **التخزين الدائم**: في قاعدة البيانات PostgreSQL
- **البحث والتصفية**: حسب النوع والحالة
- **البيانات الوصفية**: معلومات إضافية مع كل إشعار

### 3. واجهة المستخدم
- **تصميم عصري**: واجهة سهلة الاستخدام
- **دعم RTL**: للغة العربية
- **استجابة**: يعمل على جميع الأجهزة
- **أيقونات تفاعلية**: حسب نوع الإشعار

## أنواع الإشعارات

- **success**: إشعارات النجاح (أخضر)
- **error**: إشعارات الخطأ (أحمر)
- **warning**: إشعارات التحذير (أصفر)
- **info**: إشعارات المعلومات (أزرق)

## التكامل مع النظام

### طلبات الجملة
تم تحديث معالج `UpdateRequestStatus` في `wholesale.go` لحفظ الإشعارات:
- إشعار الموافقة على طلب الجملة
- إشعار رفض طلب الجملة
- تفاصيل السبب في حالة الرفض

### الاستخدام في المعالجات
```go
// إنشاء خدمة الإشعارات
notificationService := services.NewNotificationService()

// إنشاء إشعار جديد
notification, err := notificationService.CreateNotification(
    userID,
    "success",
    "عنوان الإشعار",
    "محتوى الإشعار",
    metadata,
)
```

## الأمان

- **المصادقة**: جميع endpoints محمية بـ JWT
- **التفويض**: المستخدم يرى إشعاراته فقط
- **التحقق من الصحة**: فلترة وتنظيف البيانات

## الأداء

- **الفهرسة**: فهارس محسنة لقاعدة البيانات
- **التصفح**: دعم pagination للإشعارات
- **التخزين المؤقت**: تحسين الاستعلامات المتكررة

## الاختبار

لاختبار النظام:

1. **تشغيل الخادم**: `go run main.go`
2. **تسجيل الدخول**: كمستخدم أو مدير
3. **إنشاء إشعار**: عبر طلب جملة أو عملية أخرى
4. **فحص الواجهة**: مركز الإشعارات في شريط التنقل

## التطوير المستقبلي

- [ ] إشعارات البريد الإلكتروني
- [ ] إشعارات الرسائل النصية
- [ ] تجميع الإشعارات المتشابهة
- [ ] إعدادات تفضيلات الإشعارات
- [ ] تنظيف الإشعارات القديمة تلقائياً

## الدعم الفني

للمساعدة أو الإبلاغ عن مشاكل، يرجى التواصل مع فريق التطوير.
