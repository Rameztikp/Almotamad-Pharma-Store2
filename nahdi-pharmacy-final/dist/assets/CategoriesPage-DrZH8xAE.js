import{r as c,j as t,E as ne,z as m,H as ce,t as $}from"./index--DLPBvsr.js";import{O as oe,A as de,E as xe,G as me}from"./index-BjbvdVW9.js";const A={name:"",description:"",image_url:"",is_active:!0,sort_order:0},ge=()=>{const[_,G]=c.useState([]),[H,E]=c.useState(!0),[k,P]=c.useState(!1),[f,J]=c.useState(""),[Q,b]=c.useState(!1),[u,j]=c.useState(null),[o,v]=c.useState(A),[X,L]=c.useState(!1),[S,U]=c.useState(null),[F,q]=c.useState([]),[Y,I]=c.useState(!1),[C,B]=c.useState(""),[h,N]=c.useState([]),w=async()=>{E(!0);try{const e=await ne.getCategories(),s=(e==null?void 0:e.data)||e;G(Array.isArray(s)?s:(s==null?void 0:s.data)||[])}catch(e){console.error("Failed to fetch categories",e),m.error("فشل في جلب الفئات")}finally{E(!1)}},Z=e=>{N(s=>{const r=e.id||e._id;return!r||s.some(a=>(a.id||a._id)===r)?s:[...s,{...e,quantity:1}]});try{m.success("تمت إضافة المنتج")}catch{}},R=e=>{N(s=>s.filter(r=>(r.id||r._id)!==e))};c.useEffect(()=>{w()},[]);const z=e=>{var n,y,i,p;if(!e||typeof e!="string")return"";const r=(()=>{var M,O,W,K;const d=(((O=(M=import.meta)==null?void 0:M.env)==null?void 0:O.VITE_FILES_BASE_URL)||"").toString().trim();if(d)return d.replace(/\/$/,"");const x=(((K=(W=import.meta)==null?void 0:W.env)==null?void 0:K.VITE_API_BASE_URL)||"").toString().trim();if(x)try{return new URL(x).origin.replace(/\/$/,"")}catch{return x.replace(/\/$/,"")}if(typeof window<"u"&&window.location){const{protocol:ie,hostname:le}=window.location;return`${ie}//${le}:8080`}return"http://localhost:8080"})();let a=e.trim().replace(/\\/g,"/");if(a.startsWith("uploads/")&&(a=`/${a}`),/^https?:\/\//i.test(a)){try{const d=new URL(a);if(d.pathname.startsWith("/uploads")){const x=`${r}${d.pathname}${d.search||""}`;if((y=(n=import.meta)==null?void 0:n.env)!=null&&y.DEV)try{console.debug("[normalizeUrl:absolute-rewrite]",{input:a,filesBase:r,rewritten:x})}catch{}return x}}catch{}return a}const l=`${r}${a.startsWith("/")?"":"/"}${a}`;if((p=(i=import.meta)==null?void 0:i.env)!=null&&p.DEV)try{console.debug("[normalizeUrl]",{input:e,sanitized:a,filesBase:r,resolved:l})}catch{}return l},V=e=>{var n,y;if(!e)return"";const s=[],r=i=>{if(i){if(typeof i=="string"){const p=i.startsWith("uploads/")?`/${i}`:i;s.push(p);return}if(typeof i=="object"){const d=[i.url,i.path,i.src,i.href,i.download_url,i.fileUrl,i.file_url,i.full_url,i.secure_url,i.image_url,i.original,i.original_url].find(x=>typeof x=="string"&&x.trim().length>0);if(d){s.push(d);return}}}};if(r(e.image_url),r(e.imageUrl),r(e.image),r(e.thumbnail),r(e.main_image),r(e.photo),r(e.cover_url),r(e.imagePath),r(e.featured_image),e.cover&&r(e.cover),e.media){const i=Array.isArray(e.media)?e.media[0]:e.media;r(i)}Array.isArray(e.images)&&e.images.length&&r(e.images.find(i=>typeof i=="string"&&i.trim())||e.images[0]),Array.isArray(e.photos)&&e.photos.length&&r(e.photos.find(i=>typeof i=="string"&&i.trim())||e.photos[0]);const a=s.find(i=>typeof i=="string"&&i.trim().length>0)||"",l=z(a);if((y=(n=import.meta)==null?void 0:n.env)!=null&&y.DEV)try{console.debug("[getProductImage]",{productId:e.id||e._id,candidates:s,chosen:a,resolved:l})}catch{}return l},ee=e=>{if(!e)return;const s=[e.stock,e.quantity,e.stock_qty,e.stock_quantity,e.available_quantity,e.available_stock,e.quantity_available,e.qty_available,e.inventory,e.inventory_quantity,e.stockCount,e.qty];let r=s.find(l=>typeof l=="number");if(typeof r=="number")return r;const a=s.find(l=>typeof l=="string"&&/^\d+$/.test(l.trim()));if(a)return parseInt(a.trim(),10);if(typeof e.in_stock=="boolean")return e.in_stock?"متوفر":"غير متوفر"},D=c.useMemo(()=>{if(!f)return _;const e=f.toLowerCase();return _.filter(s=>{var r,a;return((r=s.name)==null?void 0:r.toLowerCase().includes(e))||((a=s.description)==null?void 0:a.toLowerCase().includes(e))})},[_,f]),te=()=>{j(null),v(A),b(!0)},se=e=>{j(e.id),v({name:e.name||"",description:e.description||"",image_url:e.image_url||e.imageUrl||"",is_active:typeof e.is_active=="boolean"?e.is_active:e.isActive??!0,sort_order:e.sort_order??e.sortOrder??0}),b(!0)},T=async e=>{U(e),L(!0),I(!0),q([]),B(""),N([]);try{const s={is_active:"true","filters[$and][2][$or][0][categories][id][$eq]":e.id};e.slug&&(s["filters[$and][2][$or][1][categories][slug][$eq]"]=e.slug);const r=await ce.fetchProductsByType({type:"retail",page:1,limit:200,filters:s,clientCategoryId:e.id,clientCategorySlug:e.slug}),a=Array.isArray(r==null?void 0:r.data)?r.data:[];q(a)}catch(s){console.error("Failed to fetch category products",s),m.error("فشل في جلب منتجات الفئة")}finally{I(!1)}},g=e=>{const{name:s,value:r,type:a,checked:l}=e.target;v(n=>({...n,[s]:a==="checkbox"?l:r}))},re=async e=>{var s,r,a;e.preventDefault(),P(!0);try{const l={name:(s=o.name)==null?void 0:s.trim(),description:((r=o.description)==null?void 0:r.trim())||"",image_url:((a=o.image_url)==null?void 0:a.trim())||"",is_active:!!o.is_active,sort_order:Number(o.sort_order)||0};let n;u?n=await $.updateCategory(u,l):n=await $.createCategory(l),n!=null&&n.success?(m.success(u?"تم تحديث الفئة":"تم إضافة فئة"),b(!1),v(A),j(null),await w()):m.error((n==null?void 0:n.message)||"حدث خطأ")}catch(l){console.error("Save category error",l),m.error("فشل حفظ الفئة")}finally{P(!1)}},ae=async e=>{if(window.confirm("هل أنت متأكد من حذف هذه الفئة؟"))try{const s=await $.deleteCategory(e);s!=null&&s.success?(m.success("تم حذف الفئة"),await w()):m.error((s==null?void 0:s.message)||"تعذر حذف الفئة")}catch(s){console.error("Delete category error",s),m.error("فشل حذف الفئة")}};return t.jsxs("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:[t.jsxs("div",{className:"p-6 border-b border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between",children:[t.jsxs("div",{className:"mb-3 md:mb-0",children:[t.jsx("h2",{className:"text-xl font-semibold",children:"إدارة الفئات"}),t.jsx("p",{className:"text-sm text-gray-500",children:"إضافة وتعديل وحذف الفئات"})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("button",{onClick:w,className:"btn btn-secondary flex items-center gap-2 px-3 py-2 border rounded hover:bg-gray-50",children:[t.jsx(oe,{})," تحديث"]}),t.jsxs("button",{onClick:te,className:"btn btn-primary flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:[t.jsx(de,{})," إضافة فئة"]})]})]}),t.jsx("div",{className:"p-4",children:t.jsx("input",{type:"text",placeholder:"ابحث بالاسم أو الوصف...",className:"w-full md:w-1/2 border rounded px-3 py-2",value:f,onChange:e=>J(e.target.value)})}),H?t.jsx("div",{className:"flex justify-center items-center h-64",children:t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):D.length?t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الاسم"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الوصف"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الصورة"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ترتيب"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"نشط"}),t.jsx("th",{className:"px-4 py-3"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:D.map(e=>t.jsxs("tr",{children:[t.jsx("td",{className:"px-4 py-3 whitespace-nowrap font-medium",children:t.jsx("button",{onClick:()=>T(e),className:"text-blue-600 hover:underline",children:e.name})}),t.jsx("td",{className:"px-4 py-3",children:e.description||"-"}),t.jsx("td",{className:"px-4 py-3",children:e.image_url||e.imageUrl?t.jsx("img",{src:z(e.image_url||e.imageUrl),alt:e.name,className:"h-10 w-10 object-cover rounded"}):t.jsx("span",{className:"text-gray-400",children:"لا توجد"})}),t.jsx("td",{className:"px-4 py-3",children:e.sort_order??e.sortOrder??0}),t.jsx("td",{className:"px-4 py-3",children:t.jsx("span",{className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${e.is_active??e.isActive?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600"}`,children:e.is_active??e.isActive?"نعم":"لا"})}),t.jsxs("td",{className:"px-4 py-3 text-left whitespace-nowrap",children:[t.jsxs("button",{onClick:()=>se(e),className:"text-blue-600 hover:text-blue-800 mx-2 inline-flex items-center gap-1",children:[t.jsx(xe,{})," تعديل"]}),t.jsxs("button",{onClick:()=>ae(e.id),className:"text-red-600 hover:text-red-800 mx-2 inline-flex items-center gap-1",children:[t.jsx(me,{})," حذف"]}),t.jsx("button",{onClick:()=>T(e),className:"text-gray-700 hover:text-gray-900 mx-2 inline-flex items-center gap-1",children:"عرض المنتجات"})]})]},e.id))})]})}):t.jsx("div",{className:"text-center py-16 text-gray-500",children:"لا توجد فئات مطابقة"}),X&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-5xl max-h-[85vh] flex flex-col",children:[t.jsxs("div",{className:"px-5 py-4 border-b flex items-center justify-between",children:[t.jsxs("h3",{className:"text-lg font-semibold",children:["منتجات الفئة: ",(S==null?void 0:S.name)||""]}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:"text-sm text-gray-600",children:"مختارة:"}),t.jsx("span",{className:"inline-flex items-center justify-center min-w-[2rem] h-8 px-2 rounded-full bg-blue-100 text-blue-800 text-sm font-semibold",children:h.length}),t.jsx("button",{className:"text-gray-600 hover:text-gray-900",onClick:()=>{L(!1),U(null)},children:"إغلاق"})]})]}),t.jsx("div",{className:"p-4 border-b",children:t.jsx("input",{type:"text",value:C,onChange:e=>B(e.target.value),placeholder:"ابحث عن منتج بالاسم أو الوصف أو SKU",className:"w-full border rounded px-3 py-2"})}),t.jsx("div",{className:"flex-1 overflow-auto p-4",children:Y?t.jsx("div",{className:"text-center py-16 text-gray-500",children:"جارٍ تحميل المنتجات..."}):F.length===0?t.jsx("div",{className:"text-center py-16 text-gray-500",children:"لا توجد منتجات في هذه الفئة"}):t.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الصورة"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الاسم"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"SKU"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"السعر"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"المخزون"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"نشط"}),t.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"إجراء"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:F.filter(e=>{var r,a,l;if(!C)return!0;const s=C.toLowerCase();return((r=e.name)==null?void 0:r.toLowerCase().includes(s))||((a=e.description)==null?void 0:a.toLowerCase().includes(s))||((l=e.sku)==null?void 0:l.toLowerCase().includes(s))}).map(e=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-4 py-3",children:(()=>{const s=V(e),r=(()=>{try{const a=new URL(s);if(a.hostname==="localhost")return s.replace("://localhost","://127.0.0.1");if(a.hostname==="127.0.0.1")return s.replace("://127.0.0.1","://localhost")}catch{}return s})();return s?t.jsx("img",{src:s,alt:e.name,className:"h-10 w-10 object-cover rounded",onError:a=>{r&&r!==s&&(a.currentTarget.onerror=null,a.currentTarget.src=r)}}):t.jsx("span",{className:"text-gray-400",children:"—"})})()}),t.jsxs("td",{className:"px-4 py-3",children:[t.jsx("div",{className:"font-medium text-gray-900",children:e.name}),t.jsx("div",{className:"text-xs text-gray-500 line-clamp-2",children:e.description})]}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:e.sku||e.SKU||"—"}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:e.price??e.unit_price??"—"}),t.jsx("td",{className:"px-4 py-3 text-gray-700",children:ee(e)??"—"}),t.jsx("td",{className:"px-4 py-3",children:t.jsx("span",{className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${e.is_active??e.isActive?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600"}`,children:e.is_active??e.isActive?"نعم":"لا"})}),t.jsx("td",{className:"px-4 py-3 text-left",children:(()=>{const s=e.id||e._id;return h.some(a=>(a.id||a._id)===s)?t.jsxs("div",{className:"inline-flex items-center gap-2",children:[t.jsx("span",{className:"text-green-700 text-sm",children:"مضاف"}),t.jsx("button",{className:"text-red-600 hover:text-red-800 text-sm",onClick:()=>R(s),children:"إزالة"})]}):t.jsx("button",{className:"px-3 py-1.5 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm",onClick:()=>Z(e),children:"إضافة"})})()})]},e.id||e._id))})]})}),h.length>0&&t.jsxs("div",{className:"border-t p-4 bg-gray-50",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("h4",{className:"font-semibold text-gray-800",children:["عناصر مختارة (",h.length,")"]}),t.jsx("button",{className:"text-sm text-gray-600 hover:text-gray-900",onClick:()=>N([]),children:"تفريغ"})]}),t.jsx("div",{className:"max-h-40 overflow-auto divide-y",children:h.map(e=>t.jsxs("div",{className:"py-2 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[(()=>{const s=V(e);return s?t.jsx("img",{src:s,alt:e.name,className:"h-8 w-8 object-cover rounded"}):null})(),t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.name}),t.jsx("div",{className:"text-xs text-gray-500",children:e.sku||"—"})]})]}),t.jsx("button",{className:"text-xs text-red-600 hover:text-red-800",onClick:()=>R(e.id||e._id),children:"إزالة"})]},e.id||e._id))})]})]})}),Q&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:t.jsxs("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-lg",children:[t.jsx("div",{className:"px-5 py-4 border-b",children:t.jsx("h3",{className:"text-lg font-semibold",children:u?"تعديل فئة":"إضافة فئة"})}),t.jsxs("form",{onSubmit:re,className:"p-5 space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1 text-sm",children:"الاسم"}),t.jsx("input",{name:"name",value:o.name,onChange:g,required:!0,className:"w-full border rounded px-3 py-2"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1 text-sm",children:"الوصف"}),t.jsx("textarea",{name:"description",value:o.description,onChange:g,rows:3,className:"w-full border rounded px-3 py-2"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1 text-sm",children:"رابط الصورة"}),t.jsx("input",{name:"image_url",value:o.image_url,onChange:g,className:"w-full border rounded px-3 py-2",placeholder:"https://..."})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block mb-1 text-sm",children:"ترتيب العرض"}),t.jsx("input",{name:"sort_order",type:"number",value:o.sort_order,onChange:g,className:"w-full border rounded px-3 py-2"})]}),t.jsxs("div",{className:"flex items-center gap-2 pt-6",children:[t.jsx("input",{id:"is_active",name:"is_active",type:"checkbox",checked:!!o.is_active,onChange:g}),t.jsx("label",{htmlFor:"is_active",children:"نشط"})]})]}),t.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[t.jsx("button",{type:"button",className:"px-4 py-2 border rounded",onClick:()=>{b(!1),j(null)},children:"إلغاء"}),t.jsx("button",{disabled:k,type:"submit",className:`px-4 py-2 rounded text-white ${k?"bg-blue-400":"bg-blue-600 hover:bg-blue-700"}`,children:k?"جارٍ الحفظ...":u?"تحديث":"إضافة"})]})]})]})})]})};export{ge as default};
