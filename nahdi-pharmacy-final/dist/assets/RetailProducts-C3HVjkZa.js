import{r as i,a as Ne,j as e,B as S,z as c,w as ve,y as ke,A as Se,x as Ce,E as _e,D as ee}from"./index-CuvcPO5u.js";import{A as Pe,B as De,C as h,y as C,D as se,E as Ae,G as Ee}from"./index-Bb6a-7BK.js";import{S as Fe,P as Le,A as _,a as P,b as D,c as A,d as E,e as F,f as L}from"./alert-dialog-DW3mt05Y.js";import"./index-Etes9v6-.js";const He=()=>{const[b,x]=i.useState([]),[f,te]=i.useState([]),[$,d]=i.useState([]),[ae,O]=i.useState(!1),[U,re]=i.useState(""),[I,ie]=i.useState("all"),[R,j]=i.useState(!1),[$e,w]=i.useState(null),[le,M]=i.useState(!0),[Oe,B]=i.useState(!1),[Ue,ne]=i.useState([]),[Ie,Re]=i.useState({}),[Me,Be]=i.useState({}),[n,W]=i.useState(null),[oe,N]=i.useState(!1),[m,z]=i.useState(!1),[ce,v]=i.useState(!1),[u,q]=i.useState(null),[p,G]=i.useState(!1),[g,H]=i.useState(!1),[o,J]=i.useState(null),[de,k]=i.useState(!1);Ne();const ue=s=>{W(s),N(!0)},xe=s=>{q(s),v(!0)},he=s=>{Q(s)?(J(s),k(!0)):c("المنتج غير منشور بالفعل",{icon:"⚠️",style:{borderRadius:"10px",background:"#f8fafc",color:"#0f172a"}})},me=async s=>{if(u)try{G(!0),await ke(u.id,s,a=>{x(a),d(a)})&&await y()}catch(t){console.error("Error publishing product:",t)}finally{G(!1),v(!1),q(null)}},ge=async()=>{if(o)try{H(!0);const s=b.findIndex(l=>l.id===o.id);if(s===-1)return;const t={...o,is_published:!1,published_at:null,status:"inactive",is_active:!1,is_published_retail:!1,published_at_retail:null,published_retail:!1},a=[...b];if(a[s]=t,x(a),d(a),await Se(o.id,"retail",l=>{x(l),d(l)})){console.log("Unpublish successful, refreshing data...");try{await y(),await K(),c.success("تم إلغاء نشر المنتج بنجاح",{position:"top-center",duration:3e3})}catch(l){console.error("Error refreshing data after unpublish:",l)}}else x(l=>[...l]),d(l=>[...l]),c.error("فشل إلغاء نشر المنتج. يرجى المحاولة مرة أخرى",{position:"top-center",duration:3e3})}catch(s){console.error("Error in handleUnpublish:",s),x(t=>[...t]),d(t=>[...t]),c.error(s.message||"حدث خطأ أثناء محاولة إلغاء نشر المنتج",{position:"top-center",duration:3e3})}finally{H(!1),k(!1),J(null)}},fe=async()=>{if(n){z(!0);try{console.log("Deleting product:",n.id);const s=await Ce(n.id);if(s.success){const t=b.filter(a=>a.id!==n.id);x(t),d(t),c.success(s.message||"تم حذف المنتج بنجاح",{position:"top-center",duration:3e3})}else throw new Error(s.error||"فشل حذف المنتج")}catch(s){console.error("Error deleting product:",s),c.error(s.message||"حدث خطأ أثناء حذف المنتج",{position:"top-center",duration:3e3})}finally{z(!1),N(!1),W(null)}}},pe=async()=>{try{O(!0);const s=await _e.getCategories();let t=[];Array.isArray(s)?t=s:s&&Array.isArray(s.data)?t=s.data:s&&s.data&&typeof s.data=="object"&&(t=Object.values(s.data)),te(t||[])}catch(s){console.error("Error fetching categories:",s),c.error("حدث خطأ أثناء جلب الأقسام")}finally{O(!1)}},be=s=>{if(!s)return console.log("❌ No image path provided"),null;const t="http://localhost:8080";if(s.startsWith("http")||s.startsWith("blob:"))return console.log("✅ Using full URL:",s),s;const a=[`${t}${s.startsWith("/")?"":"/"}${s}`,`${t}/uploads/${s.replace(/^\/+/,"")}`,`${t}/api/v1/uploads/${s.replace(/^\/+/,"")}`,`${t}/public/uploads/${s.replace(/^\/+/,"")}`];console.log("🔄 Trying possible image paths for",s,":",a);const r=a[0];return console.log("📤 Using image URL:",r),r},y=async()=>{try{M(!0),console.log("Fetching retail products...");const a=((await ee({limit:1e3,type:"retail"})).data||[]).filter(r=>r&&(r.type==="retail"||r.product_type==="retail"||r.is_retail===!0));return x(a),d(a),a}catch(s){return console.error("Error fetching products:",s),c.error("حدث خطأ أثناء جلب المنتجات"),[]}finally{M(!1)}},K=async()=>{try{B(!0);const s=await ee({type:"retail",published_retail:!0,limit:1e3});s&&s.data&&ne(s.data)}catch(s){console.error("Error fetching published retail products:",s)}finally{B(!1)}},Q=s=>s?s.published_retail===!0||s.is_published_retail===!0||s.status==="published"||s.is_published===!0:!1,ye=async s=>{var t,a;try{const r={...s,type:"retail"};console.log("Creating retail product:",JSON.stringify(r,null,2)),await ve(r),c.success("تمت إضافة المنتج بنجاح"),y()}catch(r){console.error("Error adding retail product:",r);const l=((a=(t=r.response)==null?void 0:t.data)==null?void 0:a.message)||"حدث خطأ أثناء إضافة المنتج";throw c.error(l),r}};i.useEffect(()=>{(async()=>{await Promise.all([pe(),y()]),await K()})()},[]);const je=s=>{const t=s.target.value.toLowerCase();re(t),T(t,I)},T=(s,t)=>{console.log("بدء تصفية المنتجات:",{term:s,categoryId:t});let a=[...b];if(s){const r=s.toLowerCase();a=a.filter(l=>{var V,X,Y,Z;return((V=l.name_ar)==null?void 0:V.toLowerCase().includes(r))||((X=l.name)==null?void 0:X.toLowerCase().includes(r))||((Y=l.description_ar)==null?void 0:Y.toLowerCase().includes(r))||((Z=l.description)==null?void 0:Z.toLowerCase().includes(r))}),console.log("بعد التصفية حسب البحث:",a.length)}t&&t!=="all"&&(a=a.filter(r=>{const l=r.category_id==t;return console.log(`المنتج: ${r.name_ar||r.name} - معرف الفئة: ${r.category_id} - تطابق: ${l}`),l}),console.log("بعد التصفية حسب الفئة:",a.length)),d(a)},we=s=>{w(s),j(!0)};return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"منتجات التجزئة"}),e.jsxs("button",{onClick:()=>{w(null),j(!0)},className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center",children:[e.jsx(Pe,{className:"ml-2"}),"إضافة منتج جديد"]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(De,{className:"text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"بحث عن منتج...",className:"w-full pr-10 pl-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:U,onChange:je})]}),e.jsx("div",{className:"w-full md:w-64",children:e.jsx(Fe,{options:[{value:"all",label:"جميع الفئات"},...Array.isArray(f)?f.map(s=>({value:s.id,label:s.name_ar||s.name})):[]],value:I,onChange:s=>{ie(s),T(U,s)},placeholder:"اختر فئة",loading:ae,noOptionsMessage:"لا توجد فئات متاحة"})})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"المنتج"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الفئة"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"السعر"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"المخزون"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الحالة"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الإجراءات"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:le?e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"text-center py-4",children:e.jsx(h,{className:"animate-spin mx-auto text-2xl"})})}):$.length>0?$.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-10 w-10",children:e.jsx("img",{className:"h-10 w-10 rounded-full object-cover",src:be(s.image_url||s.images&&s.images[0]),alt:s.name,onError:t=>t.target.src="https://via.placeholder.com/150"})}),e.jsx("div",{className:"mr-4",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.name})})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:(()=>{const a=(Array.isArray(f)?f:[]).find(r=>r.id===s.category_id);return(a==null?void 0:a.name)||(a==null?void 0:a.name_ar)||"غير مصنف"})()}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[s.price," ر.س"]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.stock_quantity}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.published_retail===!0||s.is_published_retail===!0?e.jsx("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800",children:"منشور"}):e.jsx("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800",children:"غير منشور"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsxs("div",{className:"flex items-center justify-end space-x-3",children:[Q(s)?e.jsx("button",{onClick:()=>he(s),className:"text-yellow-600 hover:text-yellow-900 transition duration-150 ease-in-out p-1",title:"إلغاء نشر المنتج",disabled:g&&(o==null?void 0:o.id)===s.id,children:g&&(o==null?void 0:o.id)===s.id?e.jsx(h,{className:"animate-spin"}):e.jsxs("div",{className:"flex items-center",children:[e.jsx(C,{className:"ml-1"}),e.jsx("span",{children:"إلغاء النشر"})]})}):e.jsx("button",{onClick:()=>xe(s),className:"text-green-600 hover:text-green-900 transition duration-150 ease-in-out p-1",title:"نشر المنتج",disabled:p&&(u==null?void 0:u.id)===s.id,children:p&&(u==null?void 0:u.id)===s.id?e.jsx(h,{className:"animate-spin"}):e.jsxs("div",{className:"flex items-center",children:[e.jsx(se,{className:"ml-1"}),e.jsx("span",{children:"نشر"})]})}),e.jsx("button",{onClick:()=>we(s),className:"text-indigo-600 hover:text-indigo-900 transition duration-150 ease-in-out",title:"تعديل المنتج",children:e.jsx(Ae,{})}),e.jsx("button",{onClick:()=>ue(s),className:"text-red-600 hover:text-red-900 transition duration-150 ease-in-out",title:"حذف المنتج",disabled:m&&(n==null?void 0:n.id)===s.id,children:m&&(n==null?void 0:n.id)===s.id?e.jsx(h,{className:"animate-spin"}):e.jsx(Ee,{})})]})})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"text-center py-4",children:"لا توجد منتجات."})})})]})})]}),R&&e.jsx(Le,{isOpen:R,onClose:()=>{j(!1),w(null)},onSubmit:ye,categories:f,type:"retail"}),e.jsx(_,{open:ce,onOpenChange:v,children:e.jsxs(P,{className:"bg-white dark:bg-gray-800 border-0 shadow-xl rounded-lg p-6",children:[e.jsxs(D,{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/30 mb-4",children:e.jsx(se,{className:"h-6 w-6 text-blue-600 dark:text-blue-400"})}),e.jsx(A,{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"نشر المنتج"}),e.jsx(E,{className:"mt-2 text-gray-600 dark:text-gray-300",children:"هل أنت متأكد أنك تريد نشر هذا المنتج في واجهة التجزئة؟"})]}),e.jsxs(F,{className:"flex flex-row-reverse gap-3 justify-center sm:justify-end",children:[e.jsx(S,{onClick:()=>me("retail"),disabled:p,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md shadow-sm hover:shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"animate-spin ml-2"}),"جاري النشر..."]}):"نشر للتجزئة"}),e.jsx(L,{className:"px-6 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2",disabled:p,children:"إلغاء"})]})]})}),e.jsx(_,{open:de,onOpenChange:g?void 0:k,children:e.jsxs(P,{className:"bg-white dark:bg-gray-800 border-0 shadow-xl rounded-lg p-6",children:[e.jsxs(D,{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(C,{className:"h-6 w-6 text-red-600 dark:text-red-400"})}),e.jsx(A,{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"تأكيد إلغاء النشر"}),e.jsxs(E,{className:"mt-2 text-gray-600 dark:text-gray-300",children:["هل أنت متأكد من رغبتك في إلغاء نشر المنتج"," ",e.jsx("span",{className:"font-semibold text-gray-800 dark:text-white",children:(o==null?void 0:o.name_ar)||(o==null?void 0:o.name)})," ","من واجهة التجزئة؟",e.jsx("br",{}),e.jsx("span",{className:"text-red-600 dark:text-red-400 font-medium mt-2 inline-block",children:"لن يظهر المنتج للعملاء بعد الآن."})]})]}),e.jsxs(F,{className:"flex flex-row-reverse gap-3 justify-center sm:justify-end",children:[e.jsx(S,{variant:"destructive",onClick:ge,disabled:g,className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-md shadow-sm hover:shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2",children:g?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"animate-spin ml-2"}),"جاري الإلغاء..."]}):"تأكيد الإلغاء"}),e.jsx(L,{className:"px-6 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2",disabled:g,children:"إلغاء"})]})]})}),e.jsx(_,{open:oe,onOpenChange:m?void 0:N,children:e.jsxs(P,{className:"bg-white dark:bg-gray-800 border-0 shadow-xl rounded-lg p-6",children:[e.jsxs(D,{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(C,{className:"h-6 w-6 text-red-600 dark:text-red-400"})}),e.jsx(A,{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"تأكيد الحذف"}),e.jsxs(E,{className:"mt-2 text-gray-600 dark:text-gray-300",children:["هل أنت متأكد من رغبتك في حذف المنتج"," ",e.jsx("span",{className:"font-semibold text-gray-800 dark:text-white",children:(n==null?void 0:n.name_ar)||(n==null?void 0:n.name)}),"؟",e.jsx("br",{}),e.jsx("span",{className:"text-red-600 dark:text-red-400 font-medium mt-2 inline-block",children:"هذا الإجراء لا يمكن التراجع عنه."})]})]}),e.jsxs(F,{className:"flex flex-row-reverse gap-3 justify-center sm:justify-end",children:[e.jsx(S,{variant:"destructive",onClick:fe,disabled:m,className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-md shadow-sm hover:shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2",children:m?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"animate-spin ml-2"}),"جاري الحذف..."]}):"تأكيد الحذف"}),e.jsx(L,{className:"px-6 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2",disabled:m,children:"إلغاء"})]})]})})]})};export{He as default};
