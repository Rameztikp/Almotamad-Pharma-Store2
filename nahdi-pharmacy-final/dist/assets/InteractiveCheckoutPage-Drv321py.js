import{r as j,u as ne,a as de,b as Y,j as e,S as z,L as S,B as f,C as T,M as V,c as I,d as q,e as D,f as L,I as C,n as E,o as oe}from"./index-CyoFg3u4.js";const me=(h=100,g=100,u="No Image")=>`data:image/svg+xml;charset=UTF-8,%3Csvg width='${h}' height='${g}' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' font-family='sans-serif' font-size='12' text-anchor='middle' dominant-baseline='middle' fill='%23999'%3E${encodeURIComponent(u)}%3C/text%3E%3C/svg%3E`,xe=(h,g="No Image")=>{const u=h.target;u.tagName.toLowerCase()==="img"&&(u.src=me(u.width||100,u.height||100,g),u.onerror=null)},he={lat:15.3694,lng:44.191},ue=["صنعاء","عدن","تعز","إب","الحديدة","حضرموت","ذمار","البيضاء","حجة","المحويت","ريمة","صعدة","عمران","الجوف","مأرب","شبوة","لحج","أبين","الضالع","سقطرى","المهرة","بني مطر","سنحان","خولان"];function pe(){const[h,g]=j.useState(1),[u,G]=j.useState(!1),[Q,P]=j.useState(!0),[U,J]=j.useState(!1),[X,Z]=j.useState(null),[t,p]=j.useState({fullName:"",phone:"",email:"",address:"",city:"صنعاء",district:"",street:"",location:{...he}}),{cartItems:F,clearCart:ee,user:r,loadUser:M}=ne(),R=de(),W=s=>{var a;try{const l={address:(s==null?void 0:s.address)||"",city:(s==null?void 0:s.city)||"",district:(s==null?void 0:s.district)||"",street:(s==null?void 0:s.street)||""},d=localStorage.getItem("client_user_data")||localStorage.getItem("userData");let o="";try{o=d&&((a=JSON.parse(d))==null?void 0:a.id)||""}catch{}const i=`last_shipping_address_${o}`;localStorage.setItem(i,JSON.stringify(l)),localStorage.setItem("last_shipping_address",JSON.stringify(l))}catch{}},se=()=>{var s;try{const a=localStorage.getItem("client_user_data")||localStorage.getItem("userData");let l="";try{l=a&&((s=JSON.parse(a))==null?void 0:s.id)||""}catch{}const o=[`last_shipping_address_${l}`,"last_shipping_address"];for(const i of o){const m=localStorage.getItem(i);if(m)try{const c=JSON.parse(m);if(c&&typeof c=="object")return c}catch{}}return null}catch{return null}};if(j.useEffect(()=>{r&&p(s=>{const a={...s},l=r.full_name||r.name;if(l&&!s.fullName&&(a.fullName=l),!s.phone&&r.phone){let i=String(r.phone).trim().replace(/[^\d+]/g,"");i.startsWith("+967")?i=i.slice(4):i.startsWith("00967")?i=i.slice(5):i.startsWith("967")&&(i=i.slice(3));const m=i.replace(/\D/g,"");/^7\d{8}$/.test(m)&&(a.phone=m)}return r.email&&!s.email&&(a.email=r.email),a})},[r]),j.useEffect(()=>{(async()=>{try{if(P(!0),!r||!r.id)try{await M()}catch{}if(!r||!r.id){R("/login",{state:{from:"/checkout",message:"يجب تسجيل الدخول للمتابعة إلى الدفع"},replace:!0});return}}finally{P(!1)}})()},[R,r,M]),j.useEffect(()=>{const s=se();s&&p(a=>({...a,address:a.address||s.address||"",city:a.city||s.city||"صنعاء",district:a.district||s.district||"",street:a.street||s.street||""}))},[]),j.useEffect(()=>{const s=setTimeout(async()=>{try{const l=((t==null?void 0:t.address)||"").trim()||[t==null?void 0:t.city,t==null?void 0:t.district,t==null?void 0:t.street].map(d=>typeof d=="string"?d.trim():"").filter(Boolean).join("، ");if(!l||!r||!r.id)return;await Y.updateProfile({address:l})}catch{}},1200);return()=>clearTimeout(s)},[t.address,t.city,t.district,t.street,r]),Q)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"جاري التحميل..."})]})});const v=F.reduce((s,a)=>{var i;const l=(a==null?void 0:a.product)||a||{},d=Number(l.price)||Number((i=l.attributes)==null?void 0:i.price)||Number(a==null?void 0:a.price)||0,o=Number(a==null?void 0:a.quantity)||1;return s+d*o},0),w=v>=100||v===0?0:15,A=v+w;if(F.length===0&&!u)return e.jsx("div",{className:"container mx-auto p-4 rtl:text-right min-h-screen",children:e.jsxs("div",{className:"text-center py-16",children:[e.jsx(z,{className:"mx-auto h-24 w-24 text-gray-300 mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-600 mb-4",children:"سلة التسوق فارغة"}),e.jsx("p",{className:"text-gray-500 mb-8",children:"لا يمكن إتمام عملية الدفع بدون منتجات في السلة"}),e.jsx(S,{to:"/products",children:e.jsx(f,{className:"bg-blue-600 hover:bg-blue-700 text-white px-8 py-3",children:"تصفح المنتجات"})})]})});const k=s=>/^7\d{8}$/.test(String(s||"")),te=s=>{if(s.preventDefault(),!t.fullName||!k(t.phone)||!t.email||!t.city||!t.district||!t.address){E.error("الرجاء التأكد من صحة جميع البيانات");return}W(t),g(2)},ae=async()=>{var s,a,l,d,o,i,m;if(!t.fullName||!k(t.phone)||!t.email||!t.address||!t.city||!t.district){E.error("الرجاء التأكد من صحة جميع البيانات المدخلة");return}try{J(!0),W(t);try{const x=((t==null?void 0:t.address)||"").trim()||[t==null?void 0:t.city,t==null?void 0:t.district,t==null?void 0:t.street].map($=>typeof $=="string"?$.trim():"").filter(Boolean).join("، ");x&&await Y.updateProfile({address:x})}catch{}const c=[];for(const n of F){const x=(n==null?void 0:n.product)||n||{},$=x.id||x._id,B=x.name||"منتج بدون اسم";let N=Number(x.price);if(N||(N=Number((s=x.attributes)==null?void 0:s.price)),N||(N=Number(n==null?void 0:n.price)),!N||isNaN(N)||N<=0){E.error(`سعر غير صالح للمنتج: ${B}`);return}c.push({product_id:$,product:{id:$,name:B,price:N,...x.attributes||{}},quantity:Math.max(1,parseInt(n==null?void 0:n.quantity)||1),price:N,name:B,image:((a=x.images)==null?void 0:a[0])||x.image||((d=(l=x.attributes)==null?void 0:l.images)==null?void 0:d[0])||""})}if(c.length===0)throw new Error("لا توجد عناصر في سلة التسوق");const _=(t.fullName||"").trim(),[re,...le]=_.split(/\s+/).filter(Boolean),ie=le.join(" "),H=(t.address||"").trim()||[t.city||"صنعاء",t.district||"",t.street||""].map(n=>typeof n=="string"?n.trim():"").filter(Boolean).join("، "),ce={payment_method:"cash_on_delivery",notes:"تم إنشاء الطلب من الموقع الإلكتروني",shipping_address:{full_name:_,name:_,first_name:re||_,last_name:ie||"",phone:(t.phone||"").trim(),email:(t.email||"").trim(),address:H,address_line1:H,city:t.city||"صنعاء",district:t.district||"",street:t.street||"",postal_code:t.postalCode||"",location:t.location||null},billing_address:null,items:c,subtotal:Number(v.toFixed(2)),shipping:Number(w.toFixed(2)),total:Number(A.toFixed(2))},y=await oe.createOrder(ce);let b;if(Array.isArray(y)?b=y[0]:y&&typeof y=="object"&&(b=((o=y.data)==null?void 0:o.data)||y.data||y),!b||typeof b!="object")throw new Error("استجابة غير صالحة من الخادم");const O=b.id||b._id||b.order_id||b.order_number||b.orderNumber;if(!O)throw new Error("لم يتم العثور على معرف الطلب في استجابة الخادم");Z(O),G(!0),g(4),ee(),E.success(`تم إنشاء الطلب #${O} بنجاح!`)}catch(c){const _=((m=(i=c==null?void 0:c.response)==null?void 0:i.data)==null?void 0:m.message)||(c==null?void 0:c.message)||"حدث خطأ أثناء إنشاء الطلب. يرجى المحاولة مرة أخرى.";E.error(_),window.scrollTo({top:0,behavior:"smooth"})}finally{J(!1)}},K=[{id:1,title:"معلومات الشحن",icon:V},{id:2,title:"مراجعة الطلب",icon:T},{id:3,title:"تأكيد الطلب",icon:T}];if(u){const s=X||`NH${Date.now().toString().slice(-6)}`;return e.jsx("div",{className:"container mx-auto p-4 rtl:text-right min-h-screen",children:e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsxs("div",{className:"text-center py-16",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4",children:e.jsx(T,{className:"h-8 w-8 text-green-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"تم استلام طلبك بنجاح!"}),e.jsx("p",{className:"text-gray-600 mb-8",children:"سيتم التواصل معك قريباً لتأكيد الطلب وتحديد ميعاد التوصيل"}),e.jsxs("div",{className:"max-w-md mx-auto bg-white rounded-lg shadow-sm p-6 text-right",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-4",children:"معلومات الطلب"}),e.jsxs("div",{className:"space-y-3 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"رقم الطلب"}),e.jsxs("span",{className:"font-medium text-gray-900",children:["#",s]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"تاريخ الطلب"}),e.jsx("span",{className:"font-medium text-gray-900",children:new Date().toLocaleDateString("ar-SA")})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"طريقة الدفع"}),e.jsx("span",{className:"font-medium text-gray-900",children:"الدفع عند الاستلام"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"المبلغ المتوقع"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[A," ر.س"]})]})]}),e.jsx("div",{className:"mt-6 p-3 bg-blue-50 rounded-md border border-blue-100",children:e.jsx("p",{className:"text-sm text-blue-700 text-right",children:"سيتم الاتصال بك قريباً لتأكيد الطلب وتحديد المبلغ النهائي وتفاصيل التوصيل"})})]}),e.jsxs("div",{className:"mt-8 flex flex-col sm:flex-row justify-center gap-4",children:[e.jsx(S,{to:"/shop",className:"w-full sm:w-auto",children:e.jsx(f,{className:"w-full bg-blue-600 hover:bg-blue-700 text-white",children:"العودة إلى المتجر"})}),e.jsx(S,{to:"/my-orders",className:"w-full sm:w-auto",children:e.jsxs(f,{variant:"outline",className:"w-full",children:[e.jsx(z,{className:"ml-1.5 h-4 w-4"}),"عرض طلباتي"]})})]})]})})})}return e.jsxs("div",{className:"container mx-auto p-4 rtl:text-right",children:[e.jsxs("nav",{className:"text-sm text-gray-600 mb-6",children:[e.jsx(S,{to:"/",className:"hover:text-blue-600",children:"الرئيسية"})," > ",e.jsx(S,{to:"/cart",className:"hover:text-blue-600 mr-1",children:"السلة"})," > ",e.jsx("span",{className:"text-blue-600 mr-1",children:"الدفع"})]}),e.jsx("div",{className:"mb-8",children:e.jsx("div",{className:"flex items-center justify-center space-x-4 rtl:space-x-reverse",children:K.map((s,a)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:`flex items-center justify-center w-10 h-10 rounded-full ${h>=s.id?"bg-blue-600 text-white":"bg-gray-200 text-gray-600"}`,children:e.jsx(s.icon,{className:"h-5 w-5"})}),e.jsx("span",{className:`mr-2 rtl:ml-2 text-sm ${h>=s.id?"text-blue-600 font-semibold":"text-gray-600"}`,children:s.title}),a<K.length-1&&e.jsx("div",{className:`w-8 h-0.5 mx-4 ${h>s.id?"bg-blue-600":"bg-gray-200"}`})]},s.id))})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2",children:[h===1&&e.jsxs(I,{children:[e.jsx(q,{children:e.jsxs(D,{className:"flex items-center",children:[e.jsx(V,{className:"h-6 w-6 ml-2 rtl:mr-2"}),"معلومات الشحن"]})}),e.jsx(L,{children:e.jsxs("form",{onSubmit:te,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"الاسم الكامل *"}),e.jsx(C,{type:"text",required:!0,value:t.fullName,onChange:s=>p({...t,fullName:s.target.value}),placeholder:"أدخل اسمك الكامل"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"رقم الجوال *"}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx("span",{className:"text-gray-500",children:"+967"})}),e.jsx(C,{type:"tel",required:!0,value:t.phone,onChange:s=>{const a=s.target.value.replace(/\D/g,"");(a===""||a.startsWith("7"))&&p({...t,phone:a})},onBlur:s=>{s.target.value&&!k(s.target.value)&&E.error("رقم الجوال يجب أن يبدأ بـ 7 ويتكون من 9 أرقام")},placeholder:"7xxxxxxxx",className:`pr-12 ${t.phone&&!k(t.phone)?"border-red-500":""}`,maxLength:9})]}),t.phone&&!k(t.phone)&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:"رقم الجوال يجب أن يبدأ بـ 7 ويتكون من 9 أرقام"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2",children:["البريد الإلكتروني ",r!=null&&r.email?"(تم تعبئته تلقائياً)":""]}),e.jsx(C,{type:"email",required:!0,value:t.email,onChange:s=>p({...t,email:s.target.value}),placeholder:"example@email.com",disabled:!!(r!=null&&r.email),className:r!=null&&r.email?"bg-gray-100":""})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"العنوان"}),e.jsx(C,{type:"text",required:!0,value:t.address,onChange:s=>p({...t,address:s.target.value}),placeholder:"اسم المدينة، الحي، الشارع"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"المدينة"}),e.jsx("select",{className:"w-full h-10 px-3 py-2 rounded-md border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500",value:t.city,onChange:s=>p({...t,city:s.target.value}),children:ue.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"الحي"}),e.jsx(C,{type:"text",value:t.district,onChange:s=>p({...t,district:s.target.value}),placeholder:"الحي"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"الشارع"}),e.jsx(C,{type:"text",value:t.street,onChange:s=>p({...t,street:s.target.value}),placeholder:"الشارع"})]})]}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(S,{to:"/cart",children:e.jsx(f,{variant:"outline",children:"الرجوع إلى السلة"})}),e.jsx(f,{type:"submit",className:"bg-blue-600 hover:bg-blue-700 text-white",children:"متابعة"})]})]})})]}),h===2&&e.jsxs(I,{children:[e.jsx(q,{children:e.jsx(D,{children:"مراجعة الطلب"})}),e.jsxs(L,{children:[e.jsx("div",{className:"space-y-4",children:F.map((s,a)=>{var i,m;const l=(s==null?void 0:s.product)||s||{},d=Number(l.price)||Number((i=l.attributes)==null?void 0:i.price)||Number(s==null?void 0:s.price)||0,o=Number(s==null?void 0:s.quantity)||1;return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("img",{src:((m=l.images)==null?void 0:m[0])||l.image||"",alt:l.name,className:"w-16 h-16 object-cover rounded-md border border-gray-100",onError:xe}),e.jsxs("div",{className:"mr-3",children:[e.jsx("p",{className:"font-medium text-gray-800",children:l.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:["الكمية: ",o]})]})]}),e.jsxs("p",{className:"font-medium",children:[(d*o).toFixed(2)," ريال"]})]},a)})}),e.jsxs("div",{className:"mt-6 space-y-2 text-sm border-t border-gray-100 pt-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"المجموع الفرعي:"}),e.jsxs("span",{children:[v.toFixed(2)," ريال"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"رسوم الشحن:"}),e.jsx("span",{children:w===0?"مجاني":`${(w||0).toFixed(2)} ريال`})]}),e.jsxs("div",{className:"flex justify-between font-semibold text-base border-t border-gray-100 pt-3 mt-3",children:[e.jsx("span",{children:"المجموع الكلي:"}),e.jsxs("span",{className:"text-green-600",children:[(A||0).toFixed(2)," ريال"]})]})]}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(f,{variant:"outline",onClick:()=>g(1),children:"تعديل العنوان"}),e.jsx(f,{className:"bg-blue-600 hover:bg-blue-700 text-white",onClick:()=>g(3),children:"تأكيد"})]})]})]}),h===3&&e.jsxs(I,{children:[e.jsx(q,{children:e.jsx(D,{children:"تأكيد الطلب"})}),e.jsxs(L,{children:[e.jsxs("div",{className:"space-y-2 text-sm text-gray-700",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"اسم الشحن: "}),t.fullName]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"جوال الشحن: "}),t.phone]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"العنوان: "}),t.address]})]}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(f,{variant:"outline",onClick:()=>g(2),children:"رجوع"}),e.jsx(f,{disabled:U,className:"bg-green-600 hover:bg-green-700 text-white",onClick:ae,children:U?"جارٍ الإرسال...":"إنهاء الطلب"})]})]})]})]}),e.jsx("div",{children:e.jsxs(I,{children:[e.jsx(q,{children:e.jsx(D,{children:"ملخص الطلب"})}),e.jsx(L,{children:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"المجموع الفرعي"}),e.jsxs("span",{children:[v.toFixed(2)," ريال"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الشحن"}),e.jsx("span",{children:w===0?"مجاني":`${(w||0).toFixed(2)} ريال`})]}),e.jsxs("div",{className:"flex justify-between font-semibold text-base border-t border-gray-100 pt-3 mt-3",children:[e.jsx("span",{children:"الإجمالي"}),e.jsxs("span",{className:"text-green-600",children:[(A||0).toFixed(2)," ريال"]})]})]})})]})})]})]})}export{pe as default};
