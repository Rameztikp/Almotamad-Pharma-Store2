import{r as c,j as t,ay as is,az as ns,aA as _s}from"./index-DmWW7acS.js";import{B as vs,W as As,R as ls,F as Ss,X as ks}from"./index-Dngo9_G4.js";import{a as y}from"./orderService-Dh1xZzeJ.js";import{y as o}from"./index-DIUq0c54.js";const Es=()=>{var z,M,P,q,W,J,U,$,G,Q,X,H,K,V,Y,Z,O;const[x,cs]=c.useState(""),[rs,f]=c.useState(!1),[e,j]=c.useState(null),[E,ms]=c.useState([]),[N,I]=c.useState(!1),[b,B]=c.useState(""),g=async(s="")=>{try{I(!0),B("");const a=await y.getAllOrders({page:1,limit:10,order_type:"wholesale",status:"",search:s}),n=(a==null?void 0:a.orders)||(a==null?void 0:a.data)||a||[],r=(Array.isArray(n)?n:n.orders||[]).map(i=>{var d,h,m,ss,ts,es,as;const A=i.orderNumber||i.order_number||i.id||i._id||"",S=((d=i.shippingAddress)==null?void 0:d.full_name)||((h=i.shippingAddress)==null?void 0:h.name)||((m=i.shipping_address)==null?void 0:m.full_name)||((ss=i.shipping_address)==null?void 0:ss.name)||i.customerName||((ts=i.user)==null?void 0:ts.full_name)||((es=i.user)==null?void 0:es.name)||((as=i.user)==null?void 0:as.email)||"—",k=(i.createdAt||i.created_at||"").toString().slice(0,10),C=Array.isArray(i.items)?i.items.length:Array.isArray(i.order_items)?i.order_items.length:0,F=typeof i.total=="number"?i.total:(Array.isArray(i.items)?i.items:Array.isArray(i.order_items)?i.order_items:[]).reduce((Ns,u)=>{const bs=Number(u.price||u.unit_price||u.unitPrice||0),ws=Number(u.quantity||u.qty||1);return Ns+bs*ws},0),L=`${Number(F||0).toLocaleString("ar-SA",{minimumFractionDigits:2,maximumFractionDigits:2})} ر.س`,D=ns(i.status||i.order_status||"pending"),T=i.paymentStatus==="paid"||i.payment_status==="paid"?"تم الدفع":"—";return{id:A,customer:S,date:k,amount:L,statusRaw:D,items:C,payment:T,_raw:i}});ms(r)}catch(a){console.error("Error fetching wholesale orders:",a),B("فشل في تحميل طلبات الجملة"),o.error("فشل في تحميل طلبات الجملة")}finally{I(!1)}};c.useEffect(()=>{const s=setTimeout(()=>{g(x.trim())},300);return()=>clearTimeout(s)},[x]),c.useEffect(()=>{g("")},[]);const xs=c.useMemo(()=>{const s=x.toLowerCase();return E.filter(a=>a.id.toString().toLowerCase().includes(s)||(a.customer||"").toString().toLowerCase().includes(s))},[E,x]),os=(s={})=>s.address_line1||s.addressLine1||s.AddressLine1||s.address1||s.line1||s.address||s.Address||s.street||s.street_name||s.streetName||s.street_address||s.streetAddress||s.street_ar||s.street_name_ar||s.address_line2||"",ps=(s={})=>s.district||s.neighborhood||s.neighbourhood||s.neighborhood_ar||s.district_ar||s.area||s.area_name||"",ds=(s={})=>s.city||s.City||s.city_ar||s.municipality||"",p=s=>{const a=typeof s=="string"?parseFloat(s):typeof s=="number"?s:0;return isNaN(a)?0:a},w=s=>{var n,l;const a=s.price??s.unit_price??s.unitPrice??s.sale_price??s.salePrice??((n=s.product)==null?void 0:n.sale_price)??((l=s.product)==null?void 0:l.price)??0;return p(a)},_=s=>p(s.quantity??s.qty??0),hs=(s=[],a=null)=>{if(a){const l=a.total_amount??a.totalAmount??a.total??null;if(l!=null&&!isNaN(p(l)))return p(l)}const n=(Array.isArray(s)?s:[]).reduce((l,r)=>l+w(r)*_(r),0);return p(n)},us=s=>{const a=(s==null?void 0:s.shippingAddress)||(s==null?void 0:s.shipping_address)||(s==null?void 0:s.ShippingAddress)||(s==null?void 0:s.shipping)||(s==null?void 0:s.address)||(s==null?void 0:s.billingAddress)||(s==null?void 0:s.billing_address)||{},n=a.address||a.full_address||a.fullAddress;if(n&&typeof n=="string")return n;const l=a.address_line1||a.addressLine1||a.AddressLine1||a.address1||a.line1||a.street||a.street_name||a.streetName||a.street_ar||a.street_name_ar||"",r=a.address_line2||a.addressLine2||a.AddressLine2||a.address2||a.line2||a.apartment||a.unit||a.flat||"",i=a.district||a.neighborhood||a.neighbourhood||a.neighborhood_ar||a.district_ar||a.area||a.area_name||"",A=a.building_no||a.building||"",S=a.additional_no||a.additionalNumber||"",k=a.landmark||"",C=a.city||"",F=a.state||a.region||a.province||"",L=a.postal_code||a.postalCode||a.zip||a.zipCode||"",D=a.country||"",T=[l,r,i,A,S,k,C,F,L,D].map(m=>typeof m=="string"?m.trim():"").filter(Boolean),d=new Set,h=T.filter(m=>d.has(m)?!1:(d.add(m),!0));return h.length?h.join("، "):"—"},gs=s=>{const a=new Date(s);return isNaN(a.getTime())?"—":a.toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"})},ys=s=>{const a=_s(s);return t.jsx("span",{className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${a}`,children:is(s)})},fs=s=>{j(s||null),f(!0);try{const a=(s==null?void 0:s.shippingAddress)||(s==null?void 0:s.shipping_address),n=(s==null?void 0:s.billingAddress)||(s==null?void 0:s.billing_address);console.log("[Wholesale Invoice] shippingAddress JSON:",a?JSON.stringify(a,null,2):null),console.log("[Wholesale Invoice] billingAddress JSON:",n?JSON.stringify(n,null,2):null)}catch{}},R=()=>{f(!1),j(null)},js=async s=>{const a=(s==null?void 0:s._id)||(s==null?void 0:s.id);if(!a){o.error("تعذر تحديد رقم الطلب");return}try{await y.updateOrderStatus(a,"processing","wholesale"),o.success("تم قبول الطلب وتحويله إلى قيد التجهيز");let n=null;try{n=await y.getOrderDetails(a,"wholesale")}catch{}const l=n?{...n}:{...s,status:"processing",_id:s._id||void 0,id:s.id||void 0};j(l),f(!0),setTimeout(()=>{try{window.print()}catch{}},300),g(x)}catch(n){console.error("Error accepting order:",n),o.error("فشل قبول الطلب")}},v=async(s,a)=>{try{await y.updateOrderStatus(s,a,"wholesale"),o.success("تم تحديث حالة الطلب بنجاح"),g(x)}catch(n){console.error("Error updating order status:",n),o.error("فشل في تحديث حالة الطلب")}};return t.jsxs("div",{className:"p-6",children:[t.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between mb-6",children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"إدارة طلبات الجملة"}),t.jsxs("div",{className:"relative mt-4 md:mt-0",children:[t.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:t.jsx(vs,{className:"text-gray-400"})}),t.jsx("input",{type:"text",className:"w-full md:w-64 pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"ابحث عن طلب...",value:x,onChange:s=>cs(s.target.value)})]})]}),t.jsx("div",{className:"border-b border-gray-200 mb-6",children:t.jsxs("div",{className:"py-4 px-1 font-medium text-sm text-blue-600 flex items-center",children:[t.jsx(As,{className:"inline-block ml-2"}),"الطلبات"]})}),t.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"رقم الطلب"}),t.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"العميل"}),t.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"التاريخ"}),t.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"المجموع"}),t.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الحالة"}),t.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الإجراءات"})]})}),t.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[N&&t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"px-6 py-6 text-center text-gray-500",children:"جاري التحميل..."})}),b&&!N&&t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"px-6 py-6 text-center text-red-600",children:b})}),!N&&!b&&xs.map(s=>t.jsxs("tr",{className:"hover:bg-gray-50",children:[t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:t.jsxs("button",{type:"button",className:"text-blue-600 hover:text-blue-800 hover:underline",onClick:()=>fs(s._raw),title:"عرض الفاتورة",children:["#",s.id]})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.customer}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.date}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.amount}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.jsx("div",{className:"flex items-center justify-end",children:ys(s.statusRaw)})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:t.jsxs("div",{className:"flex items-center justify-end space-x-3 space-x-reverse",children:[s.statusRaw==="pending"&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{onClick:()=>js(s._raw),className:"px-3 py-1.5 text-blue-600 hover:bg-blue-50 rounded-full transition-colors flex items-center gap-1",title:"قبول الطلب",children:[t.jsx(ls,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"قبول"})]}),t.jsxs("button",{className:"px-3 py-1.5 text-red-600 hover:bg-red-50 rounded-full transition-colors flex items-center gap-1",onClick:()=>v(s._raw._id||s._raw.id,"cancelled"),title:"إلغاء الطلب",children:[t.jsx(Ss,{className:"w-4 h-4"}),t.jsx("span",{className:"text-sm",children:"إلغاء"})]})]}),s.statusRaw==="processing"&&t.jsx("button",{className:"p-2 text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors",onClick:()=>v(s._raw._id||s._raw.id,"shipped"),title:"تم شحن الطلب",children:t.jsx(ks,{className:"w-4 h-4"})}),s.statusRaw==="shipped"&&t.jsx("button",{className:"p-2 text-green-600 hover:bg-green-50 rounded-full transition-colors",onClick:()=>v(s._raw._id||s._raw.id,"delivered"),title:"تأكيد الاستلام",children:t.jsx(ls,{className:"w-4 h-4"})})]})})]},s.id))]})]})})}),rs&&t.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:R}),t.jsxs("div",{className:"relative bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 p-6 z-10",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["فاتورة الطلب #",(e==null?void 0:e.orderNumber)||((M=(z=e==null?void 0:e._id)==null?void 0:z.substring(0,8))==null?void 0:M.toUpperCase())]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>window.print(),className:"px-3 py-1.5 bg-gray-100 text-gray-700 rounded hover:bg-gray-200",children:"طباعة"}),t.jsx("button",{onClick:R,className:"px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700",children:"إغلاق"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"بيانات الشحن"}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"اسم الشحن:"}),t.jsx("span",{className:"font-medium text-gray-900 text-left",children:((P=e==null?void 0:e.shippingAddress)==null?void 0:P.full_name)||((q=e==null?void 0:e.shippingAddress)==null?void 0:q.name)||((W=e==null?void 0:e.shipping_address)==null?void 0:W.full_name)||((J=e==null?void 0:e.shipping_address)==null?void 0:J.name)||[(U=e==null?void 0:e.shippingAddress)==null?void 0:U.first_name,($=e==null?void 0:e.shippingAddress)==null?void 0:$.last_name].filter(Boolean).join(" ")||[(G=e==null?void 0:e.shipping_address)==null?void 0:G.first_name,(Q=e==null?void 0:e.shipping_address)==null?void 0:Q.last_name].filter(Boolean).join(" ")||"—"})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"البريد الإلكتروني:"}),t.jsx("span",{className:"font-medium text-gray-900",children:((X=e==null?void 0:e.shippingAddress)==null?void 0:X.email)||((H=e==null?void 0:e.shipping_address)==null?void 0:H.email)||((K=e==null?void 0:e.user)==null?void 0:K.email)||"—"})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"جوال الشحن:"}),t.jsx("span",{className:"font-medium text-gray-900 text-left",children:((V=e==null?void 0:e.shippingAddress)==null?void 0:V.phone)||((Y=e==null?void 0:e.shipping_address)==null?void 0:Y.phone)||"—"})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"العنوان:"}),t.jsx("span",{className:"font-medium text-gray-900 text-left",children:us(e)})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"الشارع:"}),t.jsx("span",{className:"font-medium text-gray-900 text-left",children:os((e==null?void 0:e.shippingAddress)||(e==null?void 0:e.shipping_address)||(e==null?void 0:e.billingAddress)||(e==null?void 0:e.billing_address)||{})||"غير متوفر"})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"المدينة:"}),t.jsx("span",{className:"font-medium text-gray-900 text-left",children:ds((e==null?void 0:e.shippingAddress)||(e==null?void 0:e.shipping_address)||(e==null?void 0:e.billingAddress)||(e==null?void 0:e.billing_address)||{})||"غير متوفر"})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"الحي:"}),t.jsx("span",{className:"font-medium text-gray-900 text-left",children:ps((e==null?void 0:e.shippingAddress)||(e==null?void 0:e.shipping_address)||(e==null?void 0:e.billingAddress)||(e==null?void 0:e.billing_address)||{})||"—"})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("h4",{className:"font-semibold text-gray-800 mb-2",children:"بيانات الطلب"}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"التاريخ:"}),t.jsx("span",{className:"font-medium text-gray-900",children:e!=null&&e.createdAt?gs(e.createdAt):"—"})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"الحالة:"}),t.jsx("span",{className:"font-medium text-gray-900",children:is(ns(e==null?void 0:e.status))})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"طريقة الدفع:"}),t.jsx("span",{className:"font-medium text-gray-900",children:(e==null?void 0:e.paymentMethod)==="cod"?"الدفع عند الاستلام":"بطاقة ائتمان"})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"رقم الطلب:"}),t.jsx("span",{className:"font-medium text-gray-900",children:(e==null?void 0:e.orderNumber)||((O=(Z=e==null?void 0:e._id)==null?void 0:Z.substring(0,8))==null?void 0:O.toUpperCase())})]})]})]}),t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[t.jsx("thead",{className:"bg-gray-50",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"المنتج"}),t.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"السعر للوحدة"}),t.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"الكمية"}),t.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"الإجمالي"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:((e==null?void 0:e.items)||(e==null?void 0:e.order_items)||[]).map((s,a)=>{var n;return t.jsxs("tr",{children:[t.jsx("td",{className:"px-4 py-2 text-sm text-gray-700",children:((n=s.product)==null?void 0:n.name)||s.name||s.title||"—"}),t.jsxs("td",{className:"px-4 py-2 text-sm text-gray-700",children:[w(s).toLocaleString("ar-SA",{minimumFractionDigits:2,maximumFractionDigits:2})," ر.س"]}),t.jsx("td",{className:"px-4 py-2 text-sm text-gray-700",children:_(s)}),t.jsxs("td",{className:"px-4 py-2 text-sm text-gray-900 font-medium",children:[(w(s)*_(s)).toLocaleString("ar-SA",{minimumFractionDigits:2,maximumFractionDigits:2})," ر.س"]})]},a)})}),t.jsx("tfoot",{children:t.jsxs("tr",{children:[t.jsx("td",{className:"px-4 py-2 text-sm font-semibold",colSpan:3,children:"المجموع الكلي"}),t.jsxs("td",{className:"px-4 py-2 text-sm font-semibold text-gray-900",children:[hs(e==null?void 0:e.items,e).toLocaleString("ar-SA",{minimumFractionDigits:2,maximumFractionDigits:2})," ر.س"]})]})})]})})]})]})]})};export{Es as default};
