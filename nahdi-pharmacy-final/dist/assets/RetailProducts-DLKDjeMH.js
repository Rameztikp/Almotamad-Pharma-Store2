import{r,a as pe,j as e,z as P,B as K,M as G,V as d,E as Q,I as be,J as ye,K as X}from"./index-BUkTSXir.js";import{h as je,i as we,o as Ne,j as h,k as F,l as Y,m as ve,n as ke}from"./adminRoutes-CxNN_s_q.js";import{P as Ce,z as E}from"./ProductForm-7nqVvQx7.js";import"./index-Csc-4bEh.js";const Ue=()=>{const[b,x]=r.useState([]),[g,A]=r.useState([]),[$,u]=r.useState([]);r.useEffect(()=>{(async()=>{try{console.log("جاري جلب فئات التجزئة...");const t=await G.getRetailCategories();if(!t){console.error("❌ لا توجد استجابة من السيرفر"),d.error("لا توجد استجابة من السيرفر");return}console.log("📥 استجابة فئات التجزئة:",t);const a=Array.isArray(t)?t:t.data||[];A(a),a.length>0?U("all"):(console.warn("⚠️ لا توجد فئات متاحة"),d.warning("لا توجد فئات متاحة"))}catch(t){console.error("خطأ في جلب فئات التجزئة:",t),d.error("حدث خطأ في تحميل فئات التجزئة")}})()},[]);const[I,Z]=r.useState(""),[L,U]=r.useState("all"),[R,w]=r.useState(!1),[ee,N]=r.useState(null),[se,O]=r.useState(!0),[De,M]=r.useState(!1),[Se,te]=r.useState([]),[_e,Pe]=r.useState({}),[Fe,Ee]=r.useState({}),[n,D]=r.useState(null),[f,v]=r.useState(!1),[ae,S]=r.useState(!1),[m,T]=r.useState(null),[y,z]=r.useState(!1),[p,B]=r.useState(!1),[o,W]=r.useState(null),[re,_]=r.useState(!1);pe();const le=async(s,t)=>{var l,i;if(t&&(t.preventDefault(),t.stopPropagation(),(i=(l=t.nativeEvent)==null?void 0:l.stopImmediatePropagation)==null||i.call(l)),window.confirm(`هل أنت متأكد من رغبتك في حذف المنتج ${s.name}؟
هذا الإجراء لا يمكن التراجع عنه.`)){v(!0),D(s);try{console.log("Attempting to delete product:",s.id);const c=await Q(s.id);if(console.log("Delete response:",c),c&&c.success){const j=b.filter(C=>C.id!==s.id);x(j),u(j),d.success(c.message||"تم حذف المنتج بنجاح",{position:"top-center",duration:3e3})}else throw new Error((c==null?void 0:c.error)||"فشل حذف المنتج")}catch(c){console.error("Error in delete:",c),d.error(c.message||"حدث خطأ أثناء حذف المنتج",{position:"top-center",duration:3e3})}finally{v(!1),D(null)}}},ie=s=>{T(s),S(!0)},ne=s=>{V(s)?(W(s),_(!0)):d("المنتج غير منشور بالفعل",{icon:"⚠️",style:{borderRadius:"10px",background:"#f8fafc",color:"#0f172a"}})},oe=async s=>{if(m)try{z(!0),await be(m.id,s,a=>{x(a),u(a)})&&await k()}catch(t){console.error("Error publishing product:",t)}finally{z(!1),S(!1),T(null)}},ce=async()=>{if(o)try{B(!0);const s=b.findIndex(i=>i.id===o.id);if(s===-1)return;const t={...o,is_published:!1,published_at:null,status:"inactive",is_active:!1,is_published_retail:!1,published_at_retail:null,published_retail:!1},a=[...b];if(a[s]=t,x(a),u(a),await ye(o.id,"retail",i=>{x(i),u(i)})){console.log("Unpublish successful, refreshing data...");try{await k(),await H(),d.success("تم إلغاء نشر المنتج بنجاح",{position:"top-center",duration:3e3})}catch(i){console.error("Error refreshing data after unpublish:",i)}}else x(i=>[...i]),u(i=>[...i]),d.error("فشل إلغاء نشر المنتج. يرجى المحاولة مرة أخرى",{position:"top-center",duration:3e3})}catch(s){console.error("Error in handleUnpublish:",s),x(t=>[...t]),u(t=>[...t]),d.error(s.message||"حدث خطأ أثناء محاولة إلغاء نشر المنتج",{position:"top-center",duration:3e3})}finally{B(!1),_(!1),W(null)}},de=async()=>{if(n){v(!0);try{console.log("Deleting product:",n.id);const s=await Q(n.id);if(s.success){const t=b.filter(a=>a.id!==n.id);x(t),u(t),d.success(s.message||"تم حذف المنتج بنجاح",{position:"top-center",duration:3e3})}else throw new Error(s.error||"فشل حذف المنتج")}catch(s){console.error("Error deleting product:",s),d.error(s.message||"حدث خطأ أثناء حذف المنتج",{position:"top-center",duration:3e3})}finally{v(!1),setIsDeleteModalOpen(!1),D(null)}}},ue=async()=>{try{const s=await G.getCategories();A(s)}catch(s){console.error("Error fetching categories:",s),d.error("حدث خطأ أثناء جلب الأقسام")}},xe=s=>{if(!s)return console.log("❌ No image path provided"),null;const t="http://localhost:8080";if(s.startsWith("http")||s.startsWith("blob:"))return console.log("✅ Using full URL:",s),s;const a=[`${t}${s.startsWith("/")?"":"/"}${s}`,`${t}/uploads/${s.replace(/^\/+/,"")}`,`${t}/api/v1/uploads/${s.replace(/^\/+/,"")}`,`${t}/public/uploads/${s.replace(/^\/+/,"")}`];console.log("🔄 Trying possible image paths for",s,":",a);const l=a[0];return console.log("📤 Using image URL:",l),l},k=async()=>{try{O(!0),console.log("Fetching retail products...");const a=((await X({limit:1e3,type:"retail",published_retail:!0})).data||[]).filter(l=>l&&(l.type==="retail"||l.product_type==="retail"||l.is_retail===!0));return x(a),u(a),a}catch(s){return console.error("Error fetching products:",s),d.error("حدث خطأ أثناء جلب المنتجات"),[]}finally{O(!1)}},H=async()=>{try{M(!0);const s=await X({type:"retail",published_retail:!0,limit:1e3});s&&s.data&&te(s.data)}catch(s){console.error("Error fetching published retail products:",s)}finally{M(!1)}},V=s=>s?s.published_retail===!0||s.is_published_retail===!0||s.status==="published"||s.is_published===!0:!1;r.useEffect(()=>{(async()=>{await Promise.all([ue(),k()]),await H()})()},[]);const me=s=>{const t=s.target.value.toLowerCase();Z(t),q(t,L)},he=s=>{U(s),q(I,s)},q=(s,t)=>{console.log("بدء تصفية المنتجات:",{term:s,categoryId:t});let a=[...b];if(s){const l=s.toLowerCase();a=a.filter(i=>{var c,j,C,J;return((c=i.name_ar)==null?void 0:c.toLowerCase().includes(l))||((j=i.name)==null?void 0:j.toLowerCase().includes(l))||((C=i.description_ar)==null?void 0:C.toLowerCase().includes(l))||((J=i.description)==null?void 0:J.toLowerCase().includes(l))}),console.log("بعد التصفية حسب البحث:",a.length)}t&&t!=="all"&&(a=a.filter(l=>{const i=l.category_id==t;return console.log(`المنتج: ${l.name_ar||l.name} - معرف الفئة: ${l.category_id} - تطابق: ${i}`),i}),console.log("بعد التصفية حسب الفئة:",a.length)),u(a)},ge=s=>{N(s),w(!0)},fe=async()=>{await k(),w(!1),N(null)};return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"منتجات التجزئة"}),e.jsxs("button",{onClick:()=>{N(null),w(!0)},className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center",children:[e.jsx(je,{className:"ml-2"}),"إضافة منتج جديد"]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx(we,{className:"text-gray-400"})}),e.jsx("input",{type:"text",placeholder:"بحث عن منتج...",className:"w-full pr-10 pl-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:I,onChange:me})]}),e.jsxs("div",{className:"relative w-full md:w-auto",children:[e.jsxs("select",{onChange:s=>{console.log("تم اختيار فئة جديدة:",s.target.value),he(s.target.value)},className:"w-full md:w-auto p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",value:L,children:[e.jsx("option",{value:"all",children:"كل الفئات"}),g&&g.length>0?g.map(s=>{if(!s)return null;const t=s.name_ar||s.name||"فئة بدون اسم",a=s.id||s._id;return a?e.jsx("option",{value:a,children:t},a):(console.warn("فئة بدون معرف:",s),null)}).filter(Boolean):e.jsx("option",{value:"",disabled:!0,children:g===null?"جاري تحميل الفئات...":"لا توجد فئات متاحة"})]}),e.jsx("div",{className:"absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500",children:e.jsx(Ne,{className:"w-4 h-4"})}),e.jsx("div",{className:"mt-1 text-xs text-gray-500",children:g.length>0?`عرض ${g.length} فئة`:"لا توجد فئات متاحة"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"المنتج"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الفئة"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"السعر"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"المخزون"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الحالة"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"الإجراءات"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:se?e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"text-center py-4",children:e.jsx(h,{className:"animate-spin mx-auto text-2xl"})})}):$.length>0?$.map(s=>{var t;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-10 w-10",children:e.jsx("img",{className:"h-10 w-10 rounded-full object-cover",src:xe(s.image_url||s.images&&s.images[0]),alt:s.name,onError:a=>a.target.src="https://via.placeholder.com/150"})}),e.jsx("div",{className:"mr-4",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.name})})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:(t=s.category)==null?void 0:t.name}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[s.price," ر.س"]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.stock_quantity}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.published_retail===!0||s.is_published_retail===!0?e.jsx("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800",children:"منشور"}):e.jsx("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800",children:"غير منشور"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsxs("div",{className:"flex items-center justify-end space-x-3",children:[V(s)?e.jsx("button",{onClick:()=>ne(s),className:"text-yellow-600 hover:text-yellow-900 transition duration-150 ease-in-out p-1",title:"إلغاء نشر المنتج",disabled:p&&(o==null?void 0:o.id)===s.id,children:p&&(o==null?void 0:o.id)===s.id?e.jsx(h,{className:"animate-spin"}):e.jsxs("div",{className:"flex items-center",children:[e.jsx(F,{className:"ml-1"}),e.jsx("span",{children:"إلغاء النشر"})]})}):e.jsx("button",{onClick:()=>ie(s),className:"text-green-600 hover:text-green-900 transition duration-150 ease-in-out p-1",title:"نشر المنتج",disabled:y&&(m==null?void 0:m.id)===s.id,children:y&&(m==null?void 0:m.id)===s.id?e.jsx(h,{className:"animate-spin"}):e.jsxs("div",{className:"flex items-center",children:[e.jsx(Y,{className:"ml-1"}),e.jsx("span",{children:"نشر"})]})}),e.jsx("button",{onClick:()=>ge(s),className:"text-indigo-600 hover:text-indigo-900 transition duration-150 ease-in-out",title:"تعديل المنتج",children:e.jsx(ve,{})}),e.jsx("button",{onClick:a=>le(s,a),className:"text-red-600 hover:text-red-900 transition duration-150 ease-in-out",title:"حذف المنتج",disabled:f&&(n==null?void 0:n.id)===s.id,children:f&&(n==null?void 0:n.id)===s.id?e.jsx(h,{className:"animate-spin"}):e.jsx(ke,{})})]})})]},s.id)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"text-center py-4",children:"لا توجد منتجات."})})})]})})]}),R&&e.jsx(Ce,{isOpen:R,onClose:()=>{w(!1),N(null)},onSubmit:fe,product:ee,type:"retail"}),e.jsx(E,{appear:!0,show:isDeleteModalOpen,as:r.Fragment,children:e.jsxs(P,{as:"div",className:"relative z-10",onClose:()=>!f&&setIsDeleteModalOpen(!1),children:[e.jsx(E.Child,{as:r.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-25"})}),e.jsx("div",{className:"fixed inset-0 overflow-y-auto",children:e.jsx("div",{className:"flex min-h-full items-center justify-center p-4 text-center",children:e.jsx(E.Child,{as:r.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:e.jsx(P.Panel,{className:"w-full max-w-md transform overflow-hidden rounded-2xl bg-white p-6 text-right align-middle shadow-xl transition-all",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100",children:e.jsx(F,{className:"h-6 w-6 text-red-600","aria-hidden":"true"})}),e.jsx(P.Title,{as:"h3",className:"mt-3 text-lg font-medium leading-6 text-gray-900",children:"تأكيد الحذف"}),e.jsx("div",{className:"mt-2",children:e.jsxs("p",{className:"text-sm text-gray-500",children:["هل أنت متأكد من رغبتك في حذف المنتج"," ",e.jsx("span",{className:"font-semibold",children:(n==null?void 0:n.name_ar)||(n==null?void 0:n.name)}),"؟",e.jsx("br",{}),e.jsx("span",{className:"text-red-600",children:"هذا الإجراء لا يمكن التراجع عنه."})]})}),e.jsxs("div",{className:"mt-6 flex justify-center space-x-3",children:[e.jsx("button",{type:"button",className:"inline-flex justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2",onClick:()=>setIsDeleteModalOpen(!1),disabled:f,children:"إلغاء"}),e.jsx("button",{type:"button",className:"inline-flex justify-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2",onClick:de,disabled:f,children:f?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"animate-spin -mr-1 ml-2 h-4 w-4"}),"جاري الحذف..."]}):"نعم، احذف المنتج"})]})]})})})})})]})}),e.jsx(AlertDialog,{open:ae,onOpenChange:S,children:e.jsxs(AlertDialogContent,{className:"bg-white dark:bg-gray-800 border-0 shadow-xl rounded-lg p-6",children:[e.jsxs(AlertDialogHeader,{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/30 mb-4",children:e.jsx(Y,{className:"h-6 w-6 text-blue-600 dark:text-blue-400"})}),e.jsx(AlertDialogTitle,{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"نشر المنتج"}),e.jsx(AlertDialogDescription,{className:"mt-2 text-gray-600 dark:text-gray-300",children:"هل أنت متأكد أنك تريد نشر هذا المنتج في واجهة التجزئة؟"})]}),e.jsxs(AlertDialogFooter,{className:"flex flex-row-reverse gap-3 justify-center sm:justify-end",children:[e.jsx(K,{onClick:()=>oe("retail"),disabled:y,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md shadow-sm hover:shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",children:y?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"animate-spin ml-2"}),"جاري النشر..."]}):"نشر للتجزئة"}),e.jsx(AlertDialogCancel,{className:"px-6 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2",disabled:y,children:"إلغاء"})]})]})}),e.jsx(AlertDialog,{open:re,onOpenChange:p?void 0:_,children:e.jsxs(AlertDialogContent,{className:"bg-white dark:bg-gray-800 border-0 shadow-xl rounded-lg p-6",children:[e.jsxs(AlertDialogHeader,{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30 mb-4",children:e.jsx(F,{className:"h-6 w-6 text-red-600 dark:text-red-400"})}),e.jsx(AlertDialogTitle,{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"تأكيد إلغاء النشر"}),e.jsxs(AlertDialogDescription,{className:"mt-2 text-gray-600 dark:text-gray-300",children:["هل أنت متأكد من رغبتك في إلغاء نشر المنتج"," ",e.jsx("span",{className:"font-semibold text-gray-800 dark:text-white",children:(o==null?void 0:o.name_ar)||(o==null?void 0:o.name)})," ","من واجهة التجزئة؟",e.jsx("br",{}),e.jsx("span",{className:"text-red-600 dark:text-red-400 font-medium mt-2 inline-block",children:"لن يظهر المنتج للعملاء بعد الآن."})]})]}),e.jsxs(AlertDialogFooter,{className:"flex flex-row-reverse gap-3 justify-center sm:justify-end",children:[e.jsx(K,{variant:"destructive",onClick:ce,disabled:p,className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-md shadow-sm hover:shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"animate-spin ml-2"}),"جاري الإلغاء..."]}):"تأكيد الإلغاء"}),e.jsx(AlertDialogCancel,{className:"px-6 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-medium rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2",disabled:p,children:"إلغاء"})]})]})})]})};export{Ue as default};
